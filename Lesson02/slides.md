# Linux组第二次授课

## 进程，信号和服务

- 什么是进程？
简单而不太严谨地来说，进程就是正在运行的程序：当我们启动一个程序的时候，操作系统会从硬盘中读取程序文件，将程序内容加载入内存中，之后 CPU 就会执行这个程序。
<!-- 进程是现代操作系统中必不可少的概念。在 Windows 中，我们可以使用「任务管理器」查看系统运行中的进程；Linux 中同样也有进程的概念。 -->

- 管理进程的程序
  - ps: 静态的输出当前进程的信息，通常和管道符配合使用，过滤出所需的进程信息。
  - top: 动态查看当前所有程序的信息，但是功能较少。
  - htop: 在top的基础上添加了彩色界面，更容易识别和查看。同时给出快捷键提示，并支持控制进程。

<!-- 这里我们选择使用htop来演示，同时为后面发送信号的内容做铺垫。 -->

- htop界面介绍
  > htop可以使用鼠标点击绿色这一栏来进行排序，同时也支持点击进程使用，但因此jk键被赋予了别的意义而不是上下翻页...
  - 上面几行显示的就是系统整体相关信息。
    - task: 进程
    - thr: 线程
    - running: 正在运行的前台服务
    - Load Average: cpu的负载情况。三个值分别为1分钟，3分钟，15分钟内的负载情况。
  <!-- 
  线程和进程有什么关系？
  可以这么理解做个简单的比喻：进程=火车，线程=车厢

    线程在进程下行进（单纯的车厢无法运行）
    一个进程可以包含多个线程（一辆火车可以有多个车厢）
    不同进程间数据很难共享（一辆火车上的乘客很难换到另外一辆火车，比如站点换乘）
    同一进程下不同线程间数据很易共享（A车厢换到B车厢很容易）
    进程要比线程消耗更多的计算机资源（采用多列火车相比多个车厢更耗资源）
    进程间不会相互影响，一个线程挂掉将导致整个进程挂掉（一列火车不会影响到另外一列火车，但是如果一列火车上中间的一节车厢着火了，将影响到所有车厢）
    
    为什么Load Average要显示三个数据?
    我们在维护服务器的时候，需要了解服务器的运行状态。这几个数据可以让我们了解这一段时间服务器的运行状况。防止出现进程阻塞的情况。 -->

  - 下面会显示所有进程的列表。
    - PID: 进程的标识符。
    - N: nice值，表示进程的优先级(可被用户管理的，区分于内核管理的PRI)
    - S: 进程的状态。R: running; S: sleeping; T: traced/stopped; Z: zombie; D: disk sleep

- 前台和后台
  > 对于一些运行时间长的进程，我们要怎么先把他们搁置，然后干一些别的事情呢？
  答案是`ctrl + z`!
  > 按完之后，进程不见了啊？
  - 运行`jobs`!
  - 此时你会看到显示为1号的进程，就是刚才挂起到后台的任务。
  - 如果要指定编号，记得加%，像这样`fg %1`
  - 在后台运行吧: `bg` 回到前台: `fg`

  > 如果我想退出终端，但是程序继续运行呢？
  - 在命令前面使用`nohup`。如果想直接让它在后台运行，在命令后面加上`&`。
  - 当然，我们更推荐使用`tmux`(一个终端复用器)。

- tmux

```shell
sudo apt install tmux # 安装tmux
tmux # 运行tmux
```

很好，现在我们已经创建并进入tmux的一个会话了！tmux会保留我们在之前shell所在的目录。接下来是一些常用的命令：

- `ctrl +b`: 这是tmux的修饰键，我们在tmux里面按下的快捷键都会发到tmux内的终端。按下这个键，我们可以告诉tmux：我要开始管理这个会话了。
  - d: 分离终端，回到原来的shell。
  - c: 新建窗口。
  - %: 左右拆分。
  - ": 上下拆分。
  - 方向键: 切换拆分后的窗口。
  - z: 放大当前的终端。

<!-- 一个终端（硬件概念）只有一套鼠标键盘，只能有一个 shell 主持一个 session，那如果我在 SSH 连接的时候有几个程序需要同时交互的话，只有一个前台进程很不方便。而且上面说过如果 SSH 网络断开，视为终端被关闭，也就意味着前后台一起收到 SIGHUP 一起退出，好不容易设置好的临时变量什么的还得重设。

开启多个 SSH 连接似乎可以解决这个问题。但是如果程序既需要交互，又想保证不因意外断线而停止程序，就是 nohup 也帮不了。

这时 tmux 的出现，解决了会话保持与窗口复用的问题。正如上图所示，tmux 是一个分屏的、运行在命令行的模拟终端，意味着只要有命令行可用，就可以将多个交互进程集成在在一个窗口上。该窗口不因断开连接或者暂时登出而消失，而是会保存在后台，下一次登录时可以立即还原。 -->

- 信号
  - 那么，进程间怎么进行一些通信呢？
    由于进程之间不共享内存空间，也就无法直接发送信息，必须要操作系统帮忙，于是信号机制就产生了。
  - 当我们在htop中按下k的时候，会让我们选择一系列信号。这里挑选一些常见的信号。
    - SIGKILL (9)：强制终止程序。无法被捕获或忽略，适用于需要立即终止进程的情况。
    - SIGTERM (15)：请求程序正常终止。可以被捕获和忽略，通常用于优雅关闭应用。
    - SIGINT (2)：从终端发送中断信号，通常由 Ctrl+C 触发，用于终止前台进程。
    - SIGTSTP (20): 作用是暂停进程的执行。这个信号是由用户在终端中通过按下 Ctrl+Z 发送的。
    - SIGCONT (18)：用于继续运行进程，也就是我们上面提到的`fg`和`bg`命令。
    - SIGHUP (1)：终端挂起信号，在退出终端的时候，会向与终端关联的进程发送这个信号。也就是我们上面提到的`nohup`。

- systemd
